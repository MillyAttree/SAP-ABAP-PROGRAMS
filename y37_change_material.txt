*&---------------------------------------------------------------------*
*& Report  Y37_CHANGE_MATERIAL
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  Y37_CHANGE_MATERIAL NO STANDARD PAGE HEADING .

TABLES: MARA, MAKT, CDPOS, CDHDR, DD03M.

TYPES: BEGIN OF  TY_MARA,
       MATNR TYPE MATNR,
       END OF TY_MARA.

DATA: IT_MARA TYPE STANDARD TABLE OF TY_MARA,
      WA_MARA TYPE TY_MARA.

TYPES: BEGIN OF TY_MAKT,
       MATNR TYPE MATNR,
       MAKTX TYPE MAKTX,
       END OF TY_MAKT.

DATA: IT_MAKT TYPE STANDARD TABLE OF TY_MAKT,
      WA_MAKT TYPE TY_MAKT.

TYPES: BEGIN OF TY_CDHDR,
       OBJECTCLAS like CDHDR-OBJECTCLAS,
       OBJECTID LIKE CDHDR-OBJECTID,
       CHANGENR LIKE CDHDR-CHANGENR,
       UDATE LIKE CDHDR-UDATE,
       UTIME LIKE CDHDR-UTIME,
       USERNAME LIKE CDHDR-USERNAME,
       CHANGE_IND LIKE CDHDR-CHANGE_IND,
       TCODE LIKE CDHDR-TCODE,
       END OF TY_CDHDR.

DATA: IT_CDHDR TYPE STANDARD TABLE OF TY_CDHDR,
      WA_CDHDR TYPE TY_CDHDR.

TYPES: BEGIN OF TY_CDPOS,
       OBJECTCLAS like CDPOS-OBJECTCLAS,
       OBJECTID LIKE CDPOS-OBJECTID,
       CHANGENR LIKE CDPOS-CHANGENR,
       FNAME LIKE CDPOS-FNAME,
       TABKEY LIKE CDPOS-TABKEY,
       UNIT_OLD LIKE CDPOS-UNIT_OLD,
       UNIT_NEW LIKE CDPOS-UNIT_NEW,
       VALUE_OLD LIKE CDPOS-VALUE_OLD,
       VALUE_NEW LIKE CDPOS-VALUE_NEW,
       END OF TY_CDPOS.

DATA: IT_CDPOS TYPE STANDARD TABLE OF TY_CDPOS,
      WA_CDPOS TYPE TY_CDPOS.

TYPES: BEGIN OF TY_DD03M,
       TABNAME LIKE DD03M-TABNAME,
       FIELDNAME LIKE DD03M-FIELDNAME,
       DDLANGUAGE LIKE DD03M-DDLANGUAGE,
       DDTEXT LIKE DD03M-DDTEXT,
       END OF TY_DD03M.

DATA: IT_DD03M TYPE STANDARD TABLE OF TY_DD03M,
      WA_DD03M TYPE TY_DD03M.

TYPES : BEGIN OF TY_OBJECT,
      OBJECTID LIKE CDHDR-OBJECTID,
      END OF TY_OBJECT.

DATA: IT_OBJECT TYPE STANDARD TABLE OF TY_OBJECT,
      WA_OBJECT TYPE TY_OBJECT.

TYPES: BEGIN OF TY_FIN,
       MATNR TYPE MATNR,
       MAKTX TYPE MAKTX,
       OBJECTCLAS like CDHDR-OBJECTCLAS,
       OBJECTID LIKE CDHDR-OBJECTID,
       CHANGENR LIKE CDHDR-CHANGENR,
       UDATE LIKE CDHDR-UDATE,
       UTIME LIKE CDHDR-UTIME,
       USERNAME LIKE CDHDR-USERNAME,
       CHANGE_IND LIKE CDHDR-CHANGE_IND,
       TCODE LIKE CDHDR-TCODE,
       FNAME LIKE CDPOS-FNAME,
       TABKEY LIKE CDPOS-TABKEY,
       UNIT_OLD LIKE CDPOS-UNIT_OLD,
       UNIT_NEW LIKE CDPOS-UNIT_NEW,
       VALUE_OLD LIKE CDPOS-VALUE_OLD,
       VALUE_NEW LIKE CDPOS-VALUE_NEW,
       TABNAME LIKE DD03M-TABNAME,
       FIELDNAME LIKE DD03M-FIELDNAME,
       DDLANGUAGE LIKE DD03M-DDLANGUAGE,
       DDTEXT LIKE DD03M-DDTEXT,
       END OF TY_FIN.

DATA: IT_FIN TYPE STANDARD TABLE OF TY_FIN,
      WA_FIN TYPE TY_FIN.

SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
  SELECT-OPTIONS: MATNR FOR MARA-MATNR OBLIGATORY.
SELECTION-SCREEN END OF BLOCK B1.

START-OF-SELECTION.

PERFORM DATA.

PERFORM DISP.

PERFORM ALV.





FORM DATA.

  SELECT matnr from mara INTO TABLE it_mara where matnr in matnr.

    if sy-subrc <> 0.
      MESSAGE 'please check the material code ' TYPE 'e'.
    ENDIF.

    IF it_mara is not INITIAL.
      SELECT matnr maktx FROM makt INTO TABLE it_makt FOR ALL ENTRIES IN it_mara where matnr = it_mara-matnr.
    ENDIF.

    LOOP AT IT_MARA INTO WA_MARA.
    WA_OBJECT-OBJECTID = WA_MARA-MATNR.
    APPEND WA_OBJECT TO IT_OBJECT.
    ENDLOOP.

SELECT  OBJECTCLAS
        OBJECTID
        CHANGENR
        UDATE
        UTIME
        USERNAME
        CHANGE_IND
        TCODE
  FROM CDHDR INTO IT_CDHDR FOR ALL ENTRIES IN IT_OBJECT WHERE OBJECTID = IT_OBJECT-OBJECTID
                             AND OBJECTCLAS = 'MATERIAL'
                             AND CHANGE_IND = 'U'
                             AND TCODE = 'MM02'.
IF sy-subrc eq 0..
 sort it_cdhdr by objectid.
ENDIF.



  IF IT_CDHDR IS NOT INITIAL .
    SELECT OBJECTCLAS
           OBJECTID
           CHANGENR
           FNAME
           TABKEY
           UNIT_OLD
           UNIT_NEW
           VALUE_OLD
           VALUE_NEW
      FROM CDPOS INTO IT_CDPOS FOR ALL ENTRIES IN IT_CDHDR WHERE OBJECTID = IT_CDHDR-OBJECTID
                                                             AND OBJECTCLAS = 'MATERIAL'
                                                             AND CHANGE_IND = 'U'
                                                             AND TCODE = 'MM02'
                                                             AND UNIT_OLD = 'KG'.


  ENDIF.

  IF IT_CDPOS IS NOT INITIAL .
   SELECT TABNAME
          FIELDNAME
          DDLANGUAGE
          DDTEXT
      FROM DD03M INTO TABLE IT_DD03M FOR ALL ENTRIES IN IT_CDPOS WHERE FIELDNAME = IT_CDPOS-FNAME
                                                                  AND  TABNAME = 'MARA'
                                                                  AND  DDLANGUAGE = 'E'.
  ENDIF.


  LOOP AT IT_CDPOS INTO WA_CDPOS.
    WA_FIN-OBJECTID = WA_CDPOS-OBJECTID.
    WA_FIN-OBJECTCLAS = WA_CDPOS-OBJECTCLAS.
    WA_FIN-CHANGENR = WA_CDPOS-CHANGENR.
    WA_FIN-FNAME = WA_CDPOS-FNAME.
    WA_FIN-TABKEY = WA_CDPOS-TABKEY.
    WA_FIN-UNIT_OLD = WA_CDPOS-UNIT_OLD.
    WA_FIN-UNIT_NEW = WA_CDPOS-UNIT_NEW.
    WA_FIN-VALUE_NEW = WA_CDPOS-VALUE_NEW.
    WA_FIN-VALUE_OLD = WA_CDPOS-VALUE_OLD.

   CLEAR WA_CDHDR.
    READ TABLE IT_CDHDR INTO WA_CDHDR WITH KEY OBJECTID = WA_CDPOS-OBJECTID.
      WA_FIN-UDATE = WA_CDHDR-UDATE.
      WA_FIN-UTIME = WA_CDHDR-UTIME.
      WA_fIN-USERNAME = WA_CDHDR-USERNAME.
      WA_FIN-CHANGE_IND = WA_CDHDR-CHANGE_IND.
      WA_FIN-TCODE = WA_CDHDR-TCODE.

    CLEAR WA_DD03M.
    READ TABLE IT_DD03M INTO WA_DD03M WITH KEY FIELDNAME = WA_CDPOS-FNAME.
    WA_FIN-TABNAME = WA_DD03M-TABNAME.
    WA_FIN-FIELDNAME = WA_DD03M-FIELDNAME.
    WA_FIN-DDLANGUAGE = WA_DD03M-DDLANGUAGE.
    WA_FIN-DDTEXT = WA_DD03M-DDTEXT.

   APPEND WA_FIN TO IT_FIN.
    CLEAR WA_FIN.


ENDLOOP.

ENDFORM.